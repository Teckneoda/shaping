# Job Feeds

# Summary

General does not support XML feed imports like General does.

There is a 3rd party scraper (scarce details) that currently sends to Jobs apis.  More investigation / considering needs to be done about that.

## Updates In General Feeds To Support Having Job Listings In General

We could create pre-processors that could get the XML data from the Jobs clients and generate a CSV file which then could be put on the KSL FTP server.  The current feed system could then process it like normal.

The General Feeds code would need to be updated to support the [additional listing fields](https://www.notion.so/Jobs-Listing-Fields-For-Moving-Into-General-Classifieds-2bd2ac5cb2358085a57ada835369a06f?pvs=21) that need to be added for Classified Job Listings (cjl).

üëÄ¬†Scrape feed ?

# Original Discovery

Feeds run from [stage-v2.ksl.com](http://stage-v2.ksl.com) running from a checkout of the m-ksl-jobs repo.

## Feed Clients

The following Job employer groups have (or have had) feeds active on our system based on what is in [stage-v2‚Äôs crontab](https://www.notion.so/Jobs-Crons-2c42ac5cb235800abc91d4c8428c654f?pvs=21).

### Active

All active feeds appear to be configured to get XML from the client.

- [LHM (Larry H Miller)](https://nest.ksl.com/tools/job/employers/#/group/4096)
- [Workstream](https://nest.ksl.com/tools/job/employers/#/group/41069)
- [Ken Garff](https://nest.ksl.com/tools/job/employers/#/group/41066)
- [Harmons](https://nest.ksl.com/tools/job/employers/#/group/41077)

### Inactive

- [LDS Church](https://nest.ksl.com/tools/job/employers/#/group/41065)
- [PandoLogic](https://nest.ksl.com/tools/job/employers/#/employer/3809151) - No employer group (no feed settings available)
- [WasteManagement](https://nest.ksl.com/tools/job/employers/#/group/41075)

### Employer Groups With Feed Config Not Above

- [Feed Scrape Group](https://nest.ksl.com/tools/job/employers/#/group/41063) No config but maybe some process we haven‚Äôt found?
- [Vivint](https://nest.ksl.com/tools/job/employers/#/group/41062)

## Running A Feed

The main [cli command](https://www.notion.so/Jobs-Crons-2c42ac5cb235800abc91d4c8428c654f?pvs=21) to run a feed is `/usr/bin/php /export/marketplace/m-ksl-jobs/crons/feeds/importFeed.php --parser '{parser-file-name}'`.

### Parser

The {parser-file-name} is something like `KenGarff`.  That then finds a file that matches that name in `m-ksl-jobs::/crons/feeds/Parsers/preprocessors/{parser-file-name}.php`.

Each parser has differences but generally does the following:

- Get any client credentials
- Calls the client‚Äôs XML endpoint to get the data
- Parses the client‚Äôs xml
- Maps client values to DDM values
- Call `ksl-api::/classifieds/jobs/feed/handleFeedItem` with the following:
    - item (listing data)
    - employerGroupId
    - packageHolderEmployerId (only on some, unsure what this does, but is on LHM)
    - 
- Remove listings from our system that weren‚Äôt in the client‚Äôs data (cleanup) by calling `ksl-api::/classifieds/jobs/feed/cleanNonExisting` with the listing ids that were worked on in the current run.  I assume that the api endpoint gets a list of all the existing listing ids in the system, throws out those listingIds passed in, then deletes the rest.
- Send info to Slack

‚ÑπÔ∏è¬†The listing data, besides needing the listing info from the client, requires the following:

* `employerId`: String identifier.  For example the Employer Group Larry H Miller has an Employer of `LM Used Car SM Riverdale`, which has a employerId of `UCR`.  That value is passed to handleFeedItem in the `item` array and would then have to be mapped back to the employer memberId.

‚ÑπÔ∏è¬†The listing data includes `feedJobId` which would be the client‚Äôs unique value for the listing.  It would be used for identifying if a new listing needs to be created, or updating an existing one.

### Handle Feed Item

- Gets employer checking that they have an active feed and package stuff.
- Try to see if listing already exists in our system (for creating vs updating purposes).
- Validate fields
- Call Jobs GraphQL to update/create the listing
- Return listingId, memberId and ‚Äòdeducted‚Äô (if a listing was created, supposedly would use one of the Employer‚Äôs ‚Äòuses‚Äô).

## Configuration

### Employer Group

Mongo collection `classifieds.jobsEmployerGroup`

Nest link (LHM): [https://nest.ksl.com/tools/job/employers/#/group/4096](https://nest.ksl.com/tools/job/employers/#/group/4096)

Feeds run on an Employer Group level.  Each parser file has an Employer Group Id (does not map to KSL memberId, though the record does have an email address that might be used to lookup the memberId?).  Group appears to be used for having a common feed parser (get all their data in one go for all their sub-units), feed client url and billing (uses).

Feed Config Fields:

- `Format`: (xml)
- `Source`: Url to client‚Äôs api to get the xml
- `Email notification threshold`:
- `Remaining uses`: Unsure how this is used in feeds, it seems like the feeds use the Employer Package info.

### Employer

Mongo collection `classifieds.jobsEmployers`

Nest link (LHM - LM Used Car SM Murray): [https://nest.ksl.com/tools/job/employers/#/employer/2806494](https://nest.ksl.com/tools/job/employers/#/employer/2806494)

Feed Config Fields:

- `Feed Enabled`: Is the feed active?
- `Employer Id`: String that is passed in client data to identify which employer to post the listing to.
- `Employer Contact Email`: I assume it‚Äôs for setting the ‚Äòemail‚Äô field on the listing.
- `Employer Contact Phone`: I assume it‚Äôs for setting the ‚Äòphone‚Äô field on the listing.

Under Media there is `Job Logo` and `Featured Logo`.  The Job Logo I am assuming is put on their listings via the feed as the XML data from Ken Garff & Workstream doesn‚Äôt have any photo urls.  From [Ken Garff](https://nest.ksl.com/tools/job/employers/#/employer/1574083) [listings](https://jobs.ksl.com/listing/1029379) it appears like that may be the case.  Also appears like the logo shows on the user facing [Dealer Page](https://jobs.ksl.com/employer/1574083).

### Employer Packages

Nest link (LHM): [https://nest.ksl.com/tools/job/employer-packages/#lhm@ksljobs.com](https://nest.ksl.com/tools/job/employer-packages/#lhm@ksljobs.com)

Mongo collection `classifieds.jobsPackages`

Has some billing stuff and authorized users

## Example Client XML Data

### Ken Garff Listing

```xml
<wd:Report_Data>
...
<wd:Report_Entry>
<wd:workdayID>ed5f07469ee91000c151acbfca1b0001</wd:workdayID>
<wd:job_title>Automotive Detailer - Hyundai Downtown</wd:job_title>
<wd:company_name>Garff-HY, LLC</wd:company_name>
<wd:location_name>Ken Garff Hyundai Downtown - Salt Lake City, UT</wd:location_name>
<wd:city>Salt Lake City</wd:city>
<wd:state>Utah</wd:state>
<wd:zip>84101</wd:zip>
<wd:job_family>Vehicle Sales Support</wd:job_family>
<wd:job_type>Full time</wd:job_type>
<wd:job_description>
<div><p><span><span>Considering a career with Ken </span><span>Garff</span><span> Automotive Group means you are in for a great ride (excuse the car metaphor)! </span><span>We‚Äôre</span><span> not your standard dealership or group of dealerships and we are pretty darn proud of </span></span><span><span>that. We are out to do things differently and want to consistently change, grow, and progress. For that reason, our employees are proud of where they work!</span></span><span> </span></p></div><div><p><span> </span></p></div><div><p><span><span>Hyundai Downtown, a Ken </span><span>Garff</span><span> Automotive Dealership, is currently looking for </span><span>a</span><span> </span><span>Automotive </span><span>Detail</span><span>er</span><span> t</span><span>hat aligns with our core values and acts with respect, inte</span><span>grity</span><span>, gr</span><span>owth</span><span>, </span><span>h</span><span>umility</span><span> and teamwork. </span></span><span> </span></p></div><div><div><p><span> </span></p></div><div><p><b><span>Looking for:</span></b><span> </span></p></div><div><ul><li><p><span><span>Accommodating work style that produces highly precise and </span><span>accurate</span><span> </span><span>work</span></span><span> </span></p></li><li><p><span><span>Unselfish and approachable demeanor with a preference for detailed, skill-based work</span></span><span> </span></p></li><li><p><span><span>Must be 18 years or older and </span><span>be authorized to</span><span> work in the U.S with a valid in-state driver&#39;s license and </span><span>a good driving</span><span> record, per company </span><span>standards</span></span><span> </span></p></li><li><p><span><span>High School Diploma or equivalent</span></span><span> </span></p></li></ul></div></div><div><div><p><span> </span></p></div><div><p><b><span>Why </span><span>you‚Äôll</span><span> love working with us:</span></b><span> </span></p></div><div><ul><li><p><span><span>Compensation starting at $15-17 per hour, and 401k with company match‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Wellness Time Off, plus holidays, plus a Personal Purpose Day‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Medical, Dental, Vision, Disability Insurance, AD&amp;D and Life Insurance‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Flex Spending, Health Savings Account, EAP, Wellness Plan, Mental Health Support, Diabetes Management Program, and Parental Leave Stipend‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Year-end bonus program for ALL employees (</span></span><i><span>Garff</span><span> Giveback</span></i><span><span>)‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Employee discounts on vehicle purchase, parts, service and more!‚ÄØ</span></span><span> </span></p></li><li><p><span><span>Red Wing boot program (annual replacement of work boots)</span></span><span> </span></p></li></ul></div></div><div><div><p><span> </span></p></div><div><p><b><span>What </span><span>you‚Äôll</span><span> do as an Automotive Detailer (Car Wash):</span></b><span> </span></p></div><div><ul><li><p><span><span>Wash and wax vehicle exteriors</span></span><span> </span></p></li><li><p><span><span>Vacuum and clean vehicle interiors, treat interiors with spot and stain resistant chemicals to preserve and protect interior </span><span>components</span></span><span> </span></p></li><li><p><span><span>Clean engine and engine compartment with steam cleaning equipment to remove grease and </span><span>grime</span></span><span> </span></p></li><li><p><span><span>Apply paint protection and interior protection chemicals</span></span><span> </span></p></li></ul></div></div><div><div><p><span> </span></p></div><div><p><span><span>At first glance, there‚Äôs</span><span> nothing remarkable </span><span>at</span><span> Ken </span><span>Garff</span><span>.‚ÄØ Our uniforms </span><span>aren‚Äôt</span><span> flashy, and our buildings look a lot like </span><span>the</span><span> competition. You may not see it right at first, but if you </span><span>listen</span><span> </span><span>you‚Äôll</span><span> hear.‚ÄØ Because listening </span><span>isn‚Äôt</span><span> just something we do; </span><span>it‚Äôs</span><span> part of who we are.‚ÄØ </span><span>It‚Äôs</span><span> how we show that what we absolutely value the most (far more than buildings, </span><span>uniforms</span><span> or cars) is our people.‚ÄØ And we thrive on treating them right. We listen because we believe listening matters.‚ÄØ </span><span>We‚Äôre</span><span> </span><span>just different</span><span> that way.</span></span><span> </span></p></div><div><p></p><p><span><span>Will you join us as a new</span></span><b><span> Automotive Detailer (Car Wash)</span></b><span><span>?‚ÄØ Will you throw your energy and focus behind what </span><span>we‚Äôre</span><span> doing? Will you live our values and do things differently than </span><span>you‚Äôve</span><span> ever done them?‚ÄØ Will you listen and build trust and foster relationships?‚ÄØ This organization, that started as an idea by a man named Ken </span><span>Garff</span><span> </span><span>way back</span><span> in 1932, needs one thing to keep its vision intact and its purpose of reinventing an industry moving forward.‚ÄØ It needs you.</span></span><span> </span></p></div></div>
</wd:job_description>
<wd:apply_url>
https://kengarff.wd1.myworkdayjobs.com/External_Site/job/Ken-Garff-Hyundai-Downtown---Salt-Lake-City-UT/Automotive-Detailer---Hyundai-Downtown_R0040821-3/apply?source=KSL
</wd:apply_url>
</wd:Report_Entry>
...
</wd:Report_Data>
```

### Workstream

```xml
<jobs>
<publisher>Workstream</publisher>
<publisherurl>https://www.workstream.us</publisherurl>
<lastBuildDate>2025-12-09T03:22:15+00:00</lastBuildDate>
<job>
<feedJobId>36ea6643-5353611</feedJobId>
<jobTitle>Team Member</jobTitle>
<companyName>Bountiful Endeavors Inc.</companyName>
<description>
<p>Jimmy John's is looking for energetic, friendly, hardworking, enthusiastic individuals to join our team. Jimmy John's makes the world's best and fastest sandwiches. If you might enjoy working in a fun, fast-paced environment while providing exceptional customer service, we would love to hear from you. Applicants should be willing to learn, interested in providing excellent customer service, and excited about becoming part of an exceptional team. Great for first time jobs! You provide the enthusiasm, and we‚Äôll provide the training. </p><p><strong> Additional Requirements:</strong> ‚Ä¢ Must be able to lift 15-40 lbs. regularly throughout shifts ‚Ä¢ Ability to stand, bend, reach, and scoop through-out assigned shift ‚Ä¢ Ability to be mobile in walk-in refrigerator and freezer with temperatures ranging from 40¬∞ F to -10¬∞ F</p><p><strong> Essential Functions include:</strong> ‚Ä¢ Responsibility for customer product and service standards ‚Ä¢ Fostering an environment of team work ‚Ä¢ Responsibility for delivering an exceptional customer and store experience ‚Ä¢ Greeting and thanking every customer with a smile and eye contact ‚Ä¢ Executing quality store operations ‚Ä¢ Cleaning store, small wares, merchandise, and equipment as needed‚Ä¢ Must be able to operate food preparation machinery if over 18 ‚Ä¢ Adherance to all health, safety, and security guidelines ‚Ä¢ Must be able to operate cash register and handle cash transactions while adhering to all cash handling policies </p><p><strong>Benefits</strong>: ‚Ä¢ Employee Discount ‚Ä¢ Flexible Scheduling ‚Ä¢ Fun and energetic work environment ‚Ä¢ Health insurance benefits if you move into a full-time position</p><p><strong>Company Introduction:</strong></p><p>We slice our all-natural* meats and fresh veggies in-house every day. Our fresh-baked bread is made right here where you can see it, and our house-made tuna salad is fresh every day. The flavor of a ripe tomato, crisp shredded lettuce, combined with fresh-baked bread, fresh-sliced meat and real Hellmann's¬Æ mayo help us create the world‚Äôs tastiest sandwich, and our exceptional team helps us make it the fastest.</p><p>We slice our all-natural* meats and fresh veggies in-house every day. Our fresh-baked bread is made right here where you can see it, and our house-made tuna salad is fresh every day. The flavor of a ripe tomato, crisp shredded lettuce, combined with fresh-baked bread, fresh-sliced meat and real Hellmann's¬Æ mayo - that's when the magic happens. Made with love every single day since 1983. That's Jimmy Fresh!</p>
</description>
<category>8</category>
<employerStatus>pt</employerStatus>
<state>UT</state>
<city>Park City</city>
<zip>84098</zip>
<contactEmail>help@workstream.is</contactEmail>
<contactPhone>510-621-7382</contactPhone>
<applicationUrl>
https://www.workstream.us/j/71b2502a/jimmy-johns/park-city-45306/team-member-36ea6643/apply?locale=en&referer_source=KSL
</applicationUrl>
<displayEmail>false</displayEmail>
<displayPhone>false</displayPhone>
<remotetype></remotetype>
</job>
</jobs>
```

## Scrapes

There is a section in [Jobs Employer Groups](https://nest.ksl.com/tools/job/employers/#/employer/3914513) called `Feed Scrape Group`.  Don‚Äôt know much about it.  The following is what Abe said about it:

`Jobs has some feeds, pulled from XML feeds, and scraps provided by a third-party scraper. The third-party scrapper hits some endpoints feed endpoints to post, update, and delete listings.`

`The scraper hits the (FeedController api) create, update, and delete endpoints.`

# In Depth Code

Additionally check:

[Employers](https://www.notion.so/Employers-2be2ac5cb2358014a3d1e941ba9afb44?pvs=21)

[Products and paid options](https://www.notion.so/Products-and-paid-options-2bf2ac5cb23581c8bfaeed60b1da4bf8?pvs=21)

The KSL Jobs system has two types of feeds:
1. **Import Feeds** - External partners feed job listings INTO KSL Jobs
2. **Export Feeds** (not sure it‚Äôs used) - KSL Jobs exports listings OUT to partners (ZipRecruiter, Recruitology, PandoLogic)

---

## Import Feeds (Inbound)

Code in `m-ksl-jobs` repo.

### Core Components

### 1. Feed Parser Infrastructure

- **Base Class**: `crons/feeds/Parsers/JobsFeedParser.php`
- **Entry Point**: `crons/feeds/importFeed.php`
- **Usage**: `php importFeed.php --parser [ParserName] --test=[memberId]`

### 2. Active Feed Parsers

- `KenGarff.php` (employerGroupId: 41066)
- `LHM.php`
- `Harmons.php`
- `WasteManagement.php`
- `Workstream.php`
- `PandoLogic.php`

### Key Dependencies

### Database Collections

- **jobs** - Main job listings collection
- **jobsEmployers** - Employer records with feed configuration
- **jobsEmployerGroup** - Employer group records containing:
    - `feed.source` - URL to feed file
    - `feed.format` - XML, CSV, etc.
    - `feed.remainingUses` - Package usage limits
    - `feedEnabled` - Enable/disable flag
- **jobsPackages** - Package information for employers
- **jobsApplication** - Job applications

### API Endpoints (via CronApiConnector)

1. `/classifieds/jobs/category/getCategories` - Fetches KSL category mappings
2. `/classifieds/jobs/employer/getEmployerGroup` - Gets employer group config including feed source/format
3. `/classifieds/jobs/feed/handleFeedItem` - Imports individual job from feed
4. `/classifieds/jobs/feed/cleanNonExisting` - Removes jobs no longer in feed

### External Services

- **Secret Manager** - Credentials for authenticated feeds (e.g., Ken Garff)
- **Slack Notifications** - Error/warning logging via `SlackFeedLogger`
- **XML Parsing** - `Prewk\XmlStringStreamer` for streaming large XML feeds
- **CURL** - Fetches feed files from external URLs (with optional auth)

### File System

- `/tmp/job_feeds/` - Downloaded feed files stored here
- `/tmp/[ParserName]_jobs_feed.log` - Parser-specific log files

### Feed Import Flow

1. Parser instantiated with `employerGroupId`
2. Fetches employer group config from API (gets feed URL & format)
3. Downloads feed file via CURL to `/tmp/job_feeds/`
4. Streams/parses feed file (XML typically)
5. For each job record:
    - Maps external fields to KSL fields using `fieldsMap`
    - Validates/transforms data (category, state, employment status)
    - Calls `/feed/handleFeedItem` API endpoint
    - Tracks imported job IDs
6. Calls `/feed/cleanNonExisting` to archive jobs no longer in feed
7. Sends Slack notifications for errors

### Data Transformations

- **Categories**: Maps partner categories to KSL category IDs
- **States**: Full state names ‚Üí 2-letter codes
- **Employment Status**: Various formats ‚Üí ft/pt/temp/seasonal
- **HTML Sanitization**: Cleans job descriptions

---

## Export Feeds (Outbound)

### Core Components

- **Controller**: `site/application/controllers/FeedController.php`
- **Feed Types**:
    - ZipRecruiter (`/feed/ziprecruiter`)
    - Recruitology (`/feed/recruitology`)
    - PandoLogic (implied by constant)

### Key Dependencies

### Database

- **jobs collection** - Queries jobs with:
    - `onFeed` field matching feed name
    - `status` = active or moderate
    - `expireTime` >= current date
    - Excludes test member IDs (unless dev mode)

### Job Repository

- `Schema\Entities\Job\JobRepo::getFeedJobs($feed, $includeTestData)`
- Returns iterator of Job entities

### Template System

- `api/template/feedDescription.php` - Formats job descriptions for external feeds
- Uses `Template\Template` class for rendering

### Output Format

- XML generation via `XMLWriter`
- Each feed has custom XML schema:
    - **ZipRecruiter**: referencenumber, title, description, city, state, company, category, url, jobtype, education, experience, compensation
    - **Recruitology**: AdNumber, JobTitle, JobDescription, JobCity, JobState, JobZip, CompanyName, StartDate, EndDate, ApplyURL

### Field Mappings

- Category mappings (KSL ID ‚Üí Partner category string)
- Job type mappings (ft/pt/temp ‚Üí Full-Time/Part-Time/Temporary)
- Experience level mappings
- Education level mappings

### Export Flow

1. HTTP request to feed endpoint (e.g., `/feed/ziprecruiter`)
2. Query jobs collection with `onFeed` filter
3. Iterate through matching jobs
4. Transform fields using mapping arrays
5. Render job description via template
6. Build XML output
7. Return XML response

---

## Critical Dependencies Summary

### Infrastructure

- MongoDB (jobsEmployers, jobsEmployerGroup, jobs, jobsPackages collections)
- KSL API (for feed import API endpoints)
- CronApiConnector (authenticated API calls with nonce/signature)
- Secret Manager (feed credentials)
- File system access (/tmp/)

### PHP Libraries

- `Prewk\XmlStringStreamer` - XML parsing for large files
- `XMLWriter` - XML generation for export feeds
- CURL - HTTP requests for downloading feeds

### Configuration

- Employer Group records must have:
    - Valid `feed.source` URL
    - Valid `feed.format` (XML, CSV, etc.)
    - `feedEnabled = true`
- Job records must have `onFeed` array field for export eligibility

### Monitoring

- Slack notifications (via `SlackFeedLogger`)
- Log files in `/tmp/`
- Package usage tracking (`feed.remainingUses`)

---

## Integration Points

### Import Feeds Touch

1. Job creation/update workflow
2. Package consumption logic
3. Employer management
4. Category system
5. Application flow (when feed jobs have external apply URLs)

### Export Feeds Touch

1. Job listing workflow (setting `onFeed` field)
2. Job status management (active/moderate filter)
3. Job expiration logic
4. Apply tracking (feed parameter in URLs)

# Jobs Feeds to General Feeds Migration

## Current State Comparison

### Architecture Differences

| Aspect | Jobs Feeds | General Feeds (Classifieds) |
| --- | --- | --- |
| **Language** | PHP | PHP |
| **Entry Point** | `importFeed.php` (per-parser CLI) | `singleFeedProcess.php` (per-dealer CLI)`masterFeedProcess.php` (all dealers) |
| **Base Class** | `JobsFeedParser` (abstract) | `DealerFeed` (concrete) |
| **Parser Pattern** | Child classes per partner | Single flow + configuration |
| **Config Storage** | `jobsEmployerGroup` collection | `generalDealer` collection |
| **API Communication** | Custom `CronApiConnector` | `KslApi` + `CapiClient` |
| **File Format** | Primarily XML (via XmlStringStreamer) | Primarily CSV |
| **Field Mapping** | Hardcoded `$fieldsMap` array per parser | Dynamic via `FileMapper` + Mongo mapping config |
| **Validation** | Ad-hoc in each parser | Centralized `FeedValidator` class |
| **Data Storage** | Direct MongoDB writes via API | CAPI REST API (listings endpoint) |
| **Photo Handling** | Not applicable | Dedicated `PhotoHandler` class |
| **Error Handling** | Per-parser logging + Slack | Unified `RedFlag` notification system |
| **Dry Run** | Via test memberId | Built-in `--dryRun` flag |
| **Mapping UI** | None | `FileMapper` with stored mapping values |

---

## System Component Breakdown

### 1. Feed Configuration

### Jobs Feeds

```php
// Stored in jobsEmployerGroup collection
{
  employerGroupId: 41066,  
  name: "Ken Garff",
  feedEnabled: true,  
  feed: {
    source: "https://...",  // Feed URL    
    format: "XML", // File format
    remainingUses: 1000   // Package limit  
  }
}
```

### General Feeds

```php
// Stored in generalDealer collection
{
  memberId: 1234567,  
  dealerName: "ABC Motors",  
  feed: {
    status: "Active",    
    fileLocation: "https://...",    
    activeMapping: true,       // Enable field mapping    
    listingName: "John Doe",    
    listingEmail: "...",    
    listingCity: "SLC",    
    listingState: "UT",    
    listingZip: 84101,    
    messageCenterOptIn: true,    
    redFlag: {
      notifyEmail: "...",      
      reports: {
        noUpdatesInXDays: {...},        
        inventoryDrop: {...}
      }
    }
  },  
  limits: {
    status: "Active",    
    limitNumber: 100,    
    limitType: "standard"  
  }
}
```

**Differences:**
- General feeds has richer dealer metadata (contact info, limits, red flags)
- Jobs feeds has package usage tracking (`remainingUses`)
- General feeds has mapping configuration per dealer
- Jobs feeds groups employers under `employerGroup`

---

### 2. File Download & Parsing

### Jobs Feeds

- Custom CURL implementation in `JobsFeedParser::grabFeed()`
- Uses `Prewk\XmlStringStreamer` for XML
- Saves to `/tmp/job_feeds/`
- Optional `FetcherInterface` for SFTP/FTP
- Optional `PreprocessorInterface` for file transformations

### General Feeds

- Dedicated `FeedFileDownloader` class
- CSV-focused with `FileParser` (using `fgetcsv()`)
- Saves to `/tmp/` + archive to `files/original/`
- Has `FileMapper` for dynamic field mapping
- Validates header row before processing

**Effort:** Medium
- Need CSV parser for jobs (most feeds are XML)
- File mapper would need adaptation for jobs-specific fields
- Download logic is similar, can be unified

---

### 3. Field Mapping & Validation

### Jobs Feeds

```php
// KenGarff.php - hardcoded per parserprotected 
$fieldsMap = [
    'wd:job_title' => 'jobTitle',    
    'wd:location_name' => 'companyName',    
    'wd:job_type' => 'employerStatus',   
     // ... more fields
];
// Manual transformation
$this->mapCategoryField();$this->mapStateField();$this->removeHtml();
```

### General Feeds

```php
// FileMapper - stored in Mongo, editable via UI
{
  memberId: 1234567,  
  mappingVersion: 2,  
  headers: {
    clientHeaderFieldsArray: ["Stock", "Price", "Year"],    
    kslFieldArray: ["stockNumber", "price", "year"]
  },  
  mappings: [...],  
  storedValues: {
    "Make": ["Toyota", "Honda"],    
    "Model": ["Camry", "Accord"]
  }
}

// FeedValidator - centralized validation
$validationResult = $feedValidator->validateLine($fileLineArray);
```

**Key Differences:**
- **Jobs**: Field mapping is code
- **Classifieds**: Field mapping is data (editable without deploys)
- **Jobs**: Each parser has custom transformation logic
- **Classifieds**: Centralized `ListingPrepper` handles transformations

**Effort:** High
- Jobs-specific validations (employment type, education level, salary ranges)
- Category mapping differences (jobs categories vs classifieds categories)
- No current UI for jobs feed mapping management
- Would need to build/adapt mapping UI for jobs context

---

### 4. API Integration

### Jobs Feeds

```php
// CronApiConnector - custom implementation
$result = $this->apiConnector->fetch(
  '/classifieds/jobs/feed/handleFeedItem',
  array(
    'item' => json_encode($this->jobData),
    'employerGroupId' => $this->employerGroupId,
    'useTestMemberId' => $useTestMemberId
  )
);
// One API call per job
// Handles: validation, package checking, creation/update
```

### General Feeds

```php
// CapiClient - uses Classifieds API Client library
// 1. Create stub
$response = $this->capiClient->request(
  'POST',
  '/listings/create-stub',
  ['json' => $data]
);

// 2. Update with full data
$response = $this->capiClient->request(
  'PUT',
  "/listings/{$id}",
  ['json' => $data]
);
// Two API calls per new listing// More RESTful, separate concerns
```

**Differences:**
- Jobs uses custom API endpoints
- Classifieds uses CAPI REST endpoints
- Jobs has single endpoint for create/update
- Classifieds has separate stub creation + activation

**Effort:** Medium-High
- Would need to create CAPI endpoints for jobs OR
- Adapt general feeds to use jobs-specific API endpoints
- Package consumption logic differs significantly

---

### 5. Record Matching & Updates

### Jobs Feeds

```php
// Uses feedJobId from external feed
// Looks up by employerGroupId + employerId + feedJobId
// API handles the matching internally
```

### General Feeds

```php
// Uses stockNumber
$existingListings = $dealer->getExistingFeedListings($memberId);

// Returns: [listingId => stockNumber]
if ($existingListingId !== false) {
    // Update logic    
    $existingListingFullArray = $listingApiHandler->getListing($existingListingId);    
    $modifiedFieldArray = $listingPrepper->filterListingData(
        $incomingListingFieldArray,
        $existingListingFullArray    
    );    
    if (!empty($modifiedFieldArray)) {
        $listingApiHandler->updateRecord($modifiedFieldArray);    
    }
}
```

**Key Differences:**
- Classifieds fetches ALL dealer listings upfront (via ElasticSearch)
- Classifieds compares field-by-field to only update changed fields
- Jobs lets API handle matching and change detection
- Classifieds has explicit tracking of what changed

**Effort:** Medium
- Jobs would need to adopt stockNumber-style tracking OR
- General feeds would need to support jobs-style matching
- Jobs doesn‚Äôt have notion of ‚ÄústockNumber‚Äù - uses `feedJobId`

---

### 6. Cleanup & Deletion

### Jobs Feeds

```php
// After processing all jobs in feed
$result = $this->apiConnector->fetch(
    '/classifieds/jobs/feed/cleanNonExisting',    
    array(
        'employerGroupId' => $this->employerGroupId,        
        'existingAds' => json_encode($this->adsImported)
    )
);
// API handles deletion of non-imported jobs
```

### General Feeds

```php
// Tracks remaining listings during processing
unset($this->remainingFeedListings[$existingListingId]);

// After loop, delete leftovers
foreach ($this->remainingFeedListings as $listingId) {
    $listingApiHandler->deleteRecord($listingId, $this->memberId);    
    $this->listingsDeletedArray[] = $listingId;
}
// With safety checks:
// - Error threshold exceeded? Don't delete
// - All listings would be deleted? Alert and abort
```

**Key Differences:**
- Jobs: Deletion handled by API in single batch call
- Classifieds: Deletion handled by feed process, one-by-one
- Classifieds has more sophisticated safety checks
- Classifieds tracks manual vs feed listings separately

**Effort:** Low-Medium
- Safety logic from classifieds would benefit jobs
- Jobs API endpoint already handles batch deletion
- Could be enhanced with classifieds-style checks

---

### 7. Error Handling & Notifications

### Jobs Feeds

```php
// Per-parser logging to /tmp/[parser]_jobs_feed.log
$this->log($message, 'fatal');

// Slack notifications via SlackFeedLogger
$slackFeedLogger->addLogEntry('Error message');$slackFeedLogger->send();
```

### General Feeds

```php
// Unified RedFlag class
$redFlag->notifyOnFailure(
  $dealerInfo,
  $errorArray,
  ['ae', 'client'],
  $this->kslApi
);
$redFlag->notifyOnManyFailures(...);
$redFlag->notifyOnInventoryDrop(...);
$redFlag->notifyOnLimitPreventedNewListings(...);
$redFlag->notifyOnMappingNewValuesFile(...);
// Sends to both Slack + Email
// Saved to generalFeedStats Mongo collection
```

**Key Differences:**
- General feeds has more notification types
- General feeds has database persistence of results
- General feeds has configurable recipients (AE, client, both)
- General feeds has inventory monitoring

**Effort:** Low-Medium
- Jobs would benefit from RedFlag patterns
- Notification templates would need jobs-specific wording
- Stats collection format differs

---

### 8. Testing & Dry Run

### Jobs Feeds

```bash
# Test mode with specific memberId
KSL_API_ENV='dev' php importFeed.php --parser KenGarff --test=123456
```

### General Feeds

```bash
# Dry run mode (no data modifications)
php singleFeedProcess.php --memberId=123456 --dryRun

# Debug levels
php singleFeedProcess.php --memberId=123456 --debug=2

# Single record processing
php singleFeedProcess.php --memberId=123456 --stockNumber=ABC123
```

**Key Differences:**
- General feeds has true dry-run (no writes at all)
- General feeds has granular debug levels
- General feeds can process single record for testing
- Jobs test mode writes to test collection or test member

**Effort:** Low
- General feeds pattern is superior
- Easy to adopt for jobs

---

## Jobs-Specific Challenges

### 1. Domain Differences

- **Jobs Fields**: jobTitle, salaryRange, educationLevel, yearsOfExperience, employerStatus
- **Classifieds Fields**: stockNumber, price, year, make, model, mileage
- **Photos**: Classifieds has complex photo handling; jobs rarely have photos
- **Applications**: Jobs has application tracking; classifieds doesn‚Äôt
- **Packages**: Jobs uses package consumption; classifieds uses listing limits

### 2. Employer Group Model

Jobs uses a hierarchical model:

```
EmployerGroup (e.g., "Ken Garff")
  ‚îî‚îÄ> Multiple Employers (e.g., "Ken Garff Toyota", "Ken Garff Honda")
      ‚îî‚îÄ> Jobs under each employer
```

Classifieds uses flat model:

```
Dealer (memberId)
  ‚îî‚îÄ> Listings
```

**Impact:** Migration would need to flatten jobs employer structure OR extend general feeds to support grouping

### 3. File Formats

- **Jobs**: Primarily XML feeds (Ken Garff, LHM, Harmons all use XML)
- **Classifieds**: Primarily CSV

**Impact:** Would need robust XML support in general feeds

### 4. External Apply URLs

Many jobs feeds include external application URLs (bypass KSL‚Äôs apply flow)
- Classifieds doesn‚Äôt have this concept
- Would need to preserve this functionality

---

## Migration Effort Estimate

### Phase 1: Foundation (4-6 weeks)

**Goal:** Extend general feeds to support jobs domain

- [ ]  Extend `generalDealer` Mongo schema for jobs-specific fields
    - Package tracking
    - Employer group relationships
    - Application URL handling
- [ ]  Add XML parsing support to `FileParser`
    - Integrate `XmlStringStreamer` or similar
    - Support XML in addition to CSV
- [ ]  Create jobs-specific field validator
    - Employment type validation
    - Salary range validation
    - Education/experience level validation
    - Category mapping for jobs
- [ ]  Build jobs listing handler
    - Use existing jobs API endpoints OR
    - Create CAPI endpoints for jobs
- [ ]  Unit tests for jobs-specific components

**Complexity:** Medium
**Risk:** Low (additive changes, no existing functionality broken)

---

### Phase 2: Parser Migration (6-8 weeks)

**Goal:** Migrate existing parsers to new system

For each parser (KenGarff, LHM, Harmons, WasteManagement, Workstream, PandoLogic):

- [ ]  Create `generalDealer` record with feed configuration
- [ ]  Create field mapping configuration in Mongo
- [ ]  Test feed processing in dry-run mode
- [ ]  Migrate custom transformation logic
- [ ]  Parallel run (old + new systems) for validation
- [ ]  Cutover to new system
- [ ]  Deprecate old parser

**Per Parser Effort:** 1-2 weeks
**Total for 6 parsers:** 6-12 weeks (can be parallelized)
**Complexity:** Medium-High
**Risk:** Medium (data quality issues if mapping incorrect)

---

### Phase 3: Feature Parity (3-4 weeks)

**Goal:** Match/exceed existing jobs feeds capabilities

- [ ]  Package consumption integration
- [ ]  Employer group hierarchy support
- [ ]  Export feeds compatibility
    - Ensure `onFeed` field handling works
    - Maintain ZipRecruiter/Recruitology exports
- [ ]  Red flag enhancements for jobs
    - Low application rate alerts
    - Expired jobs not replaced alerts
- [ ]  Master process for all jobs feeds
    - Similar to `masterFeedProcess.php` for classifieds
- [ ]  Cron job migration

**Complexity:** Medium
**Risk:** Low

---

### Phase 4: Enhancements (2-3 weeks)

**Goal:** Leverage general feeds capabilities for jobs

- [ ]  Mapping UI for jobs feeds
    - Allow AEs to adjust field mappings without dev
    - Preview mapping results
- [ ]  Enhanced reporting
    - Feed run statistics dashboard
    - Inventory tracking over time
    - Error rate trending
- [ ]  Self-service feed onboarding
    - Upload sample file
    - Auto-detect fields
    - Guided mapping wizard

---

## Benefits of Migration

### 1. Maintainability

- **Single codebase** for all feed types (jobs + classifieds)
- **Less code duplication** (currently 6 parsers with similar logic)
- **Centralized validation** and error handling
- **Unified testing** approach

### 2. Flexibility

- **Dynamic field mapping** without code changes
- **Self-service mapping** changes for AEs
- **Easier onboarding** of new feed partners
- **Format agnostic** (XML, CSV, JSON support)

### 3. Monitoring & Ops

- **Better visibility** into feed health
- **Unified logging** and error reporting
- **Inventory tracking** and anomaly detection
- **Red flag alerts** prevent data quality issues
- **Historical statistics** for all feed runs

### 4. Developer Experience

- **One system to learn** instead of two
- **Reusable components** across verticals
- **Better testing tools** (dry-run, single record)
- **Consistent patterns** and conventions

### 5. Business Value

- **Faster partner onboarding** (days instead of weeks)
- **Reduced support burden** (fewer feed failures)
- **Data quality improvements** (better validation)
- **Cost savings** (less maintenance time)

---

## Risks & Mitigation

### Risk 1: Data Loss During Migration

**Likelihood:** Medium
**Impact:** High
**Mitigation:**
- Parallel run old and new systems for 2-4 weeks
- Compare outputs daily
- Maintain old system as fallback
- Gradual cutover (one parser at a time)

### Risk 2: XML Parsing Complexity

**Likelihood:** Medium
**Impact:** Medium
**Mitigation:**
- Leverage existing `XmlStringStreamer` library
- Comprehensive test suite with real feed samples
- XML validation before processing

### Risk 3: Field Mapping Errors

**Likelihood:** Medium
**Impact:** High
**Mitigation:**
- Extensive mapping validation during setup
- Preview mode to review mapped data
- Dry-run testing before activation
- A/B comparison of old vs new output

### Risk 4: Package Logic Differences

**Likelihood:** Low
**Impact:** High
**Mitigation:**
- Early integration with package system
- Test with real package scenarios
- Monitor package consumption closely post-launch

### Risk 5: Performance Issues

**Likelihood:** Low
**Impact:** Medium
**Mitigation:**
- Benchmark with large feed files
- Profile and optimize hot paths
- Use same streaming approach as current jobs feeds

---

## Recommendation

### Short Term (3-6 months)

**Proceed with migration** - The benefits outweigh the costs, especially:
- Reduced maintenance burden (single codebase)
- Better error handling and monitoring
- Flexibility for new partners

**Suggested Approach:**
1. Start with Phase 1 (Foundation) - 6 weeks
2. Pilot with 1-2 parsers (e.g., KenGarff + LHM) - 4 weeks
3. Evaluate pilot results
4. If successful, migrate remaining parsers - 6 weeks
5. Add enhancements based on lessons learned

### Long Term (6-12 months)

- Build mapping UI for self-service
- Unify jobs and classifieds dealer management
- Create universal feed framework for other verticals (real estate, pets, etc.)

---

## Alternative: Enhance Current System

If migration is deemed too risky or resource-intensive, consider these enhancements to current jobs feeds:

### Priority Improvements (2-3 weeks each)

1. **Add dry-run mode** like general feeds
2. **Centralize error handling** with RedFlag-style notifications
3. **Add feed stats collection** to Mongo
4. **Implement safety checks** before deletion (error threshold, inventory drop)
5. **Add single-record testing** mode for debugging

**Total Effort:** 10-15 weeks
**Benefit:** Improved current system without full migration
**Downside:** Still maintaining two separate systems

---

## Appendix A: Field Mapping Comparison

### Jobs Feed Fields

```
feedJobId, employerId, jobTitle, companyName, description,
responsibilities, qualifications, category, employerStatus,
salaryFrom, salaryTo, payRangeType, city, state, zip,
educationLevel, yearsOfExperience, industry, contactPhone,
contactEmail, applicationUrl, companyLogoBlob, companyPerks
```

### Classifieds Feed Fields

```
stockNumber, memberId, title, body, price, category, subCategory,
year, make, model, mileage, condition, vin, city, state, zip,
contactPhone, contactName, photo1-10, specifications
```

### Common Fields

```
title/jobTitle, body/description, category, city, state, zip,
contactPhone, contactEmail/contactName
```

---

## Appendix B: Technology Stack Comparison

| Component | Jobs Feeds | General Feeds | Compatible? |
| --- | --- | --- | --- |
| PHP Version | 7.4+ | 7.4+ | ‚úÖ Yes |
| MongoDB | ‚úÖ | ‚úÖ | ‚úÖ Yes |
| ElasticSearch | ‚ùå | ‚úÖ | ‚ö†Ô∏è Partial |
| CAPI | ‚ùå | ‚úÖ | ‚ö†Ô∏è Would need jobs endpoints |
| XML Parsing | XmlStringStreamer | ‚ùå | ‚ö†Ô∏è Need to add |
| CSV Parsing | ‚ùå | fgetcsv | ‚ö†Ô∏è Jobs rarely CSV |
| Nonce Auth | CronApiConnector | KslApi | ‚ö†Ô∏è Different implementations |
| DataDog | ‚ùå | ‚úÖ | ‚ö†Ô∏è Could add |
| Unit Tests | ‚ùå | ‚úÖ PHPUnit | ‚ö†Ô∏è Could add |

---

## Appendix C: API Endpoint Mapping

### Current Jobs Endpoints

```
POST /classifieds/jobs/feed/handleFeedItem
  - Creates or updates job from feed
  - Handles package consumption
  - Returns: {status, response: {adId, memberId}}

POST /classifieds/jobs/feed/cleanNonExisting
  - Deletes jobs not in current feed
  - Takes array of existing ad IDs
  - Returns: {status, response}

GET /classifieds/jobs/category/getCategories
  - Returns job category mapping
  - Returns: {response: {1: "Accounting", ...}}

GET /classifieds/jobs/employer/getEmployerGroup
  - Returns employer group config
  - Returns: {response: {employerGroup: {...}}}
```

### CAPI Endpoints (Classifieds)

```
POST /listings/create-stub
  - Creates inactive listing
  - Returns: {meta: {id}}

PUT /listings/{id}
  - Updates listing with full data
  - Can activate via classifiedStatus: "Active"
  - Returns: {meta: {id}}

DELETE /listings/{id}
  - Soft deletes listing
  - Requires memberId validation

GET /listings/{id}
  - Fetches full listing data
  - Used for change detection
```

### What‚Äôs Needed

- CAPI jobs endpoints OR
- Adapter layer in general feeds to use existing jobs API
- Recommendation: Create CAPI jobs endpoints (cleaner long-term)

---

## Appendix D: Configuration Migration Example

### Before (Jobs)

```php
// crons/feeds/Parsers/KenGarff.php
class KenGarff extends JobsFeedParser {
    protected $employerGroupId = 41066;    
    protected $fieldsMap = [
        'wd:job_title' => 'jobTitle',        
        'wd:location_name' => 'companyName',        
        'wd:job_type' => 'employerStatus',        
        'wd:job_description' => 'description',    
    ];
        
    public function parse($useTestMemberId = false) {
        // 300+ lines of parsing logic    
    }
}
```

### After (General Feeds)

```jsx
// MongoDB: generalDealer collection
{
  "_id": ObjectId("..."),  
  "memberId": 41066,  
  "dealerName": "Ken Garff Automotive",  
  "feed": {
    "status": "Active",   
    "fileLocation": "https://kengarff.com/feed.xml",    
    "format": "xml",    
    "xmlRootNode": "wd:Report_Entry",    
    "listingName": "HR Department",    
    "listingEmail": "hr@kengarff.com",
    "listingCity": "Salt Lake City",    
    "listingState": "UT",    
    "listingZip": 84101  
  },
  "mapping": {
    "headers": {
      "clientHeaderFieldsArray": [
        "wd:job_title",
        "wd:location_name",
        "wd:job_type",
        "wd:job_description"
      ],
      "kslFieldArray": [
        "jobTitle",
        "companyName",
        "employerStatus",
        "description"
      ]
    }
  }
}

// Command to run:
php singleFeedProcess.php --memberId=41066
```

**Result:**
- No PHP code needed for new feeds
- Configuration changes via Mongo/UI
- Same processing logic for all feeds